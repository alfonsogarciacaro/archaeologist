services:
  api:
    build: 
      context: ./api
      dockerfile: Dockerfile
    ports:
      - "${WEB_PORT}:8000"
    environment:
      - NODE_ENV=${NODE_ENV}
      - SCANNER_URL=${SCANNER_URL}
      - VECTORDB_HOST=${VECTORDB_HOST}
      - VECTORDB_PORT=${VECTORDB_PORT}
      - LLM_API_URL=${LLM_API_URL}
      - WEB_PORT=${WEB_PORT}
      - SCANNER_PORT=${SCANNER_PORT}
      - OTEL_SERVICE_NAME=${OTEL_SERVICE_NAME}
      - OTEL_SERVICE_VERSION=${OTEL_SERVICE_VERSION}
      - OTEL_EXPORTER_OTLP_ENDPOINT=${OTEL_EXPORTER_OTLP_ENDPOINT}
      - OTEL_EXPORTER_OTLP_PROTOCOL=${OTEL_EXPORTER_OTLP_PROTOCOL}
      - OTEL_RESOURCE_ATTRIBUTES=${OTEL_RESOURCE_ATTRIBUTES}
    volumes:
      - ./api/app:/app/app:ro
      - ./scanner:/app/scanner:ro
      - ./shared:/app/shared:ro
      - ./ui/build:/app/static:ro  # Mount built UI as static assets
      - ./mock_enterprise:/app/mock_enterprise:ro
    depends_on:
      - vectordb
      - scanner

  vectordb:
    image: ${VECTORDB_IMAGE}
    ports:
      - "${VECTORDB_PORT}:6333"
    volumes:
      - vectordb_data:/qdrant/storage
    environment:
      - QDRANT__SERVICE__HTTP_PORT=6333
      - QDRANT__SERVICE__GRPC_PORT=6334
      - QDRANT__LOG_LEVEL=INFO

  scanner:
    build: 
      context: .
      dockerfile: scanner/Dockerfile
    ports:
      - "${SCANNER_PORT}:8000"
    volumes:
      - ./scanner:/app:ro
      - ./shared:/app/shared:ro
      - ./mock_enterprise:/app/mock_enterprise:ro
    environment:
      - NODE_ENV=${NODE_ENV}
      - COMPOSE_PROJECT_NAME=${COMPOSE_PROJECT_NAME}
      - SCANNER_PORT=${SCANNER_PORT}
      - OTEL_SERVICE_NAME=archaeologist-scanner
      - OTEL_SERVICE_VERSION=${OTEL_SERVICE_VERSION}
      - OTEL_EXPORTER_OTLP_ENDPOINT=${OTEL_EXPORTER_OTLP_ENDPOINT}
      - OTEL_EXPORTER_OTLP_PROTOCOL=${OTEL_EXPORTER_OTLP_PROTOCOL}
      - OTEL_RESOURCE_ATTRIBUTES=service.name=archaeologist-scanner,service.version=${OTEL_SERVICE_VERSION},deployment.environment=${NODE_ENV}

volumes:
  vectordb_data:
version: '3.8'

services:
  app:
    build: 
      context: .
      dockerfile: Dockerfile
    ports:
      - "${WEB_PORT}:8000"
    environment:
      - NODE_ENV=${NODE_ENV}
      - SCANNER_URL=${SCANNER_URL}
      - CHROMADB_HOST=${CHROMADB_HOST}
      - CHROMADB_PORT=${CHROMADB_PORT}
      - CHROMADB_SERVER_HTTP_PORT=${CHROMADB_SERVER_HTTP_PORT}
      - LLM_API_URL=${LLM_API_URL}
      - WEB_PORT=${WEB_PORT}
      - SCANNER_PORT=${SCANNER_PORT}
      - OTEL_SERVICE_NAME=${OTEL_SERVICE_NAME}
      - OTEL_SERVICE_VERSION=${OTEL_SERVICE_VERSION}
      - OTEL_EXPORTER_OTLP_ENDPOINT=${OTEL_EXPORTER_OTLP_ENDPOINT}
      - OTEL_EXPORTER_OTLP_PROTOCOL=${OTEL_EXPORTER_OTLP_PROTOCOL}
      - OTEL_RESOURCE_ATTRIBUTES=${OTEL_RESOURCE_ATTRIBUTES}
    volumes:
      - ./api/app:/app/app:ro
      - ./scanner:/app/scanner:ro
      - ./shared:/app/shared:ro
      - ./ui:/app/ui:ro
      - ./mock_enterprise:/app/mock_enterprise:ro
    depends_on:
      - chromadb
      - scanner

  chromadb:
    image: ${CONTAINER_REGISTRY}/ubi9/minimal
    ports:
      - "${CHROMADB_PORT}:8000"
    volumes:
      - chromadb_data:/chroma/chroma
    environment:
      - CHROMA_SERVER_HOST=0.0.0.0
      - CHROMA_SERVER_HTTP_PORT=8000
    command: >
      sh -c "
      dnf update -y && dnf install -y python3 python3-pip curl && dnf clean all &&
      pip3 install chromadb &&
      python3 -m chromadb run --host 0.0.0.0 --port 8000
      "

  scanner:
    build: 
      context: .
      dockerfile: scanner/Dockerfile
    ports:
      - "${SCANNER_PORT}:8000"
    volumes:
      - ./scanner:/app:ro
      - ./shared:/app/shared:ro
      - ./mock_enterprise:/app/mock_enterprise:ro
    environment:
      - NODE_ENV=${NODE_ENV}
      - COMPOSE_PROJECT_NAME=${COMPOSE_PROJECT_NAME}
      - SCANNER_PORT=${SCANNER_PORT}
      - OTEL_SERVICE_NAME=archaeologist-scanner
      - OTEL_SERVICE_VERSION=${OTEL_SERVICE_VERSION}
      - OTEL_EXPORTER_OTLP_ENDPOINT=${OTEL_EXPORTER_OTLP_ENDPOINT}
      - OTEL_EXPORTER_OTLP_PROTOCOL=${OTEL_EXPORTER_OTLP_PROTOCOL}
      - OTEL_RESOURCE_ATTRIBUTES=service.name=archaeologist-scanner,service.version=${OTEL_SERVICE_VERSION},deployment.environment=${NODE_ENV}

volumes:
  chromadb_data:
services:
  api:
    build:
      context: .
      dockerfile: api/Dockerfile
      args:
        CONTAINER_REGISTRY: ${CONTAINER_REGISTRY}
    ports:
      - "${WEB_PORT}:8000"
    environment:
      - NODE_ENV=${NODE_ENV}
      - WEB_PORT=${WEB_PORT}
      - OTEL_SERVICE_NAME=${OTEL_SERVICE_NAME}
      - OTEL_SERVICE_VERSION=${OTEL_SERVICE_VERSION}
      - OTEL_EXPORTER_OTLP_ENDPOINT=${OTEL_EXPORTER_OTLP_ENDPOINT}
      - OTEL_EXPORTER_OTLP_PROTOCOL=${OTEL_EXPORTER_OTLP_PROTOCOL}
      - OTEL_RESOURCE_ATTRIBUTES=${OTEL_RESOURCE_ATTRIBUTES}
      # Redis configuration
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_DB=0
      # RAG and LLM configuration
      - EMBEDDING_TYPE=${EMBEDDING_TYPE}
      - EMBEDDING_MODEL=${EMBEDDING_MODEL}
      - LLM_PROVIDER=${LLM_PROVIDER}
      - LLM_API_URL=${LLM_API_URL}
      - LLM_API_KEY=${LLM_API_KEY}
    volumes:
      - ./api/app:/app/app:ro
      - ./shared:/app/shared:ro
      - ./ui/build:/app/static:ro  # Mount built UI as static assets
      - ./mock_enterprise:/app/mock_enterprise:ro
    depends_on:
      - vectordb
      - redis

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes

  vectordb:
    image: ${VECTORDB_IMAGE}
    ports:
      - "${VECTORDB_PORT}:6333"
    volumes:
      - vectordb_data:/qdrant/storage
    environment:
      - QDRANT__SERVICE__HTTP_PORT=6333
      - QDRANT__SERVICE__GRPC_PORT=6334
      - QDRANT__LOG_LEVEL=INFO

volumes:
  vectordb_data:
  redis_data: